name: PR ìë™í™”

on:
  pull_request:
    types: [opened, synchronize, reopened, edited, assigned, labeled]
  pull_request_review:
    types: [submitted]

jobs:
  pr-comment:
    name: PR ìë™ ëŒ“ê¸€
    runs-on: ubuntu-latest
    if: github.event.action == 'opened'
    
    steps:
    - name: PR ì˜¤í”ˆ í™˜ì˜ ëŒ“ê¸€
      uses: actions/github-script@v7
      with:
        script: |
          const { owner, repo, number } = context.issue;
          const welcomeMessage = `
          ğŸ‰ **ìƒˆë¡œìš´ Pull Requestë¥¼ ì—´ì–´ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤!**
          
          ## ğŸ“‹ ì²´í¬ë¦¬ìŠ¤íŠ¸
          PR ì‘ì„±ìëŠ” ë‹¤ìŒ ì‚¬í•­ë“¤ì„ í™•ì¸í•´ì£¼ì„¸ìš”:
          
          - [ ] ì½”ë“œ ë¦¬ë·° ìš”ì²­ ì™„ë£Œ
          - [ ] ê´€ë ¨ ì´ìŠˆ ë§í¬ ì¶”ê°€ (í•´ë‹¹í•˜ëŠ” ê²½ìš°)
          - [ ] í…ŒìŠ¤íŠ¸ ì½”ë“œ ì‘ì„± ì™„ë£Œ
          - [ ] ë¬¸ì„œ ì—…ë°ì´íŠ¸ ì™„ë£Œ (í•´ë‹¹í•˜ëŠ” ê²½ìš°)
          - [ ] ë¡œì»¬ì—ì„œ ëª¨ë“  í…ŒìŠ¤íŠ¸ í†µê³¼ í™•ì¸
          
          ## ğŸš€ ìë™í™”ëœ ê²€ì‚¬
          - âœ… CI/CD íŒŒì´í”„ë¼ì¸ì´ ìë™ìœ¼ë¡œ ì‹¤í–‰ë©ë‹ˆë‹¤
          - âœ… ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬ê°€ ì§„í–‰ë©ë‹ˆë‹¤
          - âœ… í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ê°€ ì¸¡ì •ë©ë‹ˆë‹¤
          
          ë¦¬ë·°ì–´ê°€ ë°°ì •ë˜ë©´ ì½”ë“œ ë¦¬ë·°ê°€ ì§„í–‰ë©ë‹ˆë‹¤. ê¶ê¸ˆí•œ ì ì´ ìˆìœ¼ë©´ ì–¸ì œë“  ì½”ë©˜íŠ¸ ë‚¨ê²¨ì£¼ì„¸ìš”! ğŸ˜Š
          `;
          
          await github.rest.issues.createComment({
            owner,
            repo,
            issue_number: number,
            body: welcomeMessage
          });

  pr-auto-assign:
    name: PR ìë™ í• ë‹¹
    runs-on: ubuntu-latest
    if: github.event.action == 'opened'
    
    steps:
    - name: íŒŒì¼ ë³€ê²½ ë‚´ìš© í™•ì¸ ë° ìë™ í• ë‹¹
      uses: actions/github-script@v7
      with:
        script: |
          const { owner, repo, number } = context.issue;
          
          // PRì˜ ë³€ê²½ëœ íŒŒì¼ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
          const { data: files } = await github.rest.pulls.listFiles({
            owner,
            repo,
            pull_number: number
          });
          
          const changedFiles = files.map(file => file.filename);
          let assignees = [];
          let reviewers = [];
          
          // íŒŒì¼ ê²½ë¡œì— ë”°ë¥¸ ìë™ í• ë‹¹ ê·œì¹™
          const backendChanged = changedFiles.some(file => file.startsWith('backend/'));
          const frontendChanged = changedFiles.some(file => file.startsWith('frontend/'));
          const docsChanged = changedFiles.some(file => file.startsWith('docs/') || file.includes('README') || file.includes('.md'));
          const testChanged = changedFiles.some(file => file.includes('test') || file.includes('spec'));
          
          // ê¸°ë³¸ ë¦¬ë·°ì–´ ì„¤ì • (ì‹¤ì œ íŒ€ì› GitHub ì•„ì´ë””ë¡œ ë³€ê²½ í•„ìš”)
          if (backendChanged) {
            reviewers.push('backend-reviewer'); // ì‹¤ì œ GitHub ì•„ì´ë””ë¡œ ë³€ê²½ í•„ìš”
          }
          if (frontendChanged) {
            reviewers.push('frontend-reviewer'); // ì‹¤ì œ GitHub ì•„ì´ë””ë¡œ ë³€ê²½ í•„ìš”
          }
          if (testChanged) {
            reviewers.push('test-reviewer'); // ì‹¤ì œ GitHub ì•„ì´ë””ë¡œ ë³€ê²½ í•„ìš”
          }
          
          // PR ì‘ì„±ìê°€ ì•„ë‹Œ ê²½ìš°ì—ë§Œ í• ë‹¹
          const prAuthor = context.payload.pull_request.user.login;
          reviewers = reviewers.filter(reviewer => reviewer !== prAuthor);
          
          if (reviewers.length > 0) {
            try {
              await github.rest.pulls.requestReviewers({
                owner,
                repo,
                pull_number: number,
                reviewers: reviewers
              });
              
              console.log(`ë¦¬ë·°ì–´ í• ë‹¹ ì™„ë£Œ: ${reviewers.join(', ')}`);
            } catch (error) {
              console.log(`ë¦¬ë·°ì–´ í• ë‹¹ ì‹¤íŒ¨: ${error.message}`);
              // ì‹¤íŒ¨í•´ë„ ì›Œí¬í”Œë¡œìš°ëŠ” ê³„ì† ì§„í–‰
            }
          }

  pr-auto-label:
    name: PR ìë™ ë¼ë²¨ë§
    runs-on: ubuntu-latest
    if: github.event.action == 'opened' || github.event.action == 'synchronize'
    
    steps:
    - name: ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: PR ì œëª© ë° íŒŒì¼ ë³€ê²½ ê¸°ë°˜ ìë™ ë¼ë²¨ë§
      uses: actions/github-script@v7
      with:
        script: |
          const { owner, repo, number } = context.issue;
          const title = context.payload.pull_request.title;
          
          // PRì˜ ë³€ê²½ëœ íŒŒì¼ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
          const { data: files } = await github.rest.pulls.listFiles({
            owner,
            repo,
            pull_number: number
          });
          
          const changedFiles = files.map(file => file.filename);
          let labels = [];
          
          // ì œëª© ê¸°ë°˜ ë¼ë²¨ë§
          if (title.includes('[FEAT]') || title.includes('[FEATURE]')) {
            labels.push('enhancement');
          }
          if (title.includes('[FIX]') || title.includes('[BUG]')) {
            labels.push('bug');
          }
          if (title.includes('[DOCS]') || title.includes('[DOC]')) {
            labels.push('documentation');
          }
          if (title.includes('[TEST]')) {
            labels.push('test');
          }
          if (title.includes('[REFACTOR]')) {
            labels.push('refactor');
          }
          if (title.includes('[URGENT]') || title.includes('[HOTFIX]')) {
            labels.push('urgent');
          }
          
          // íŒŒì¼ ê²½ë¡œ ê¸°ë°˜ ë¼ë²¨ë§
          const backendChanged = changedFiles.some(file => file.startsWith('backend/'));
          const frontendChanged = changedFiles.some(file => file.startsWith('frontend/'));
          const docsChanged = changedFiles.some(file => file.startsWith('docs/') || file.includes('README') || file.includes('.md'));
          const testChanged = changedFiles.some(file => file.includes('test') || file.includes('spec'));
          const agentChanged = changedFiles.some(file => file.includes('agent') || file.includes('langgraph'));
          
          if (backendChanged) labels.push('backend');
          if (frontendChanged) labels.push('frontend');
          if (docsChanged) labels.push('documentation');
          if (testChanged) labels.push('test');
          if (agentChanged) labels.push('agent');
          
          // ì¤‘ë³µ ì œê±°
          labels = [...new Set(labels)];
          
          if (labels.length > 0) {
            await github.rest.issues.addLabels({
              owner,
              repo,
              issue_number: number,
              labels: labels
            });
            
            console.log(`ë¼ë²¨ ì¶”ê°€ ì™„ë£Œ: ${labels.join(', ')}`);
          }

  pr-code-review:
    name: PR ìë™ ì½”ë“œ ë¦¬ë·°
    runs-on: ubuntu-latest
    if: github.event.action == 'opened' || github.event.action == 'synchronize'
    
    steps:
    - name: ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Python ì„¤ì •
      uses: actions/setup-python@v4
      with:
        python-version: 3.11
        
    - name: ì½”ë“œ í’ˆì§ˆ ë¶„ì„ ë„êµ¬ ì„¤ì¹˜
      run: |
        pip install flake8 pylint bandit safety
        
    - name: ì½”ë“œ í’ˆì§ˆ ë¶„ì„ ì‹¤í–‰
      run: |
        # Flake8 ê²€ì‚¬
        echo "## ğŸ” ì½”ë“œ í’ˆì§ˆ ë¶„ì„ ê²°ê³¼" > code_review.md
        echo "" >> code_review.md
        
        echo "### Flake8 ë¶„ì„" >> code_review.md
        if flake8 backend/ --max-line-length=127 --exclude=venv --format='%(path)s:%(row)d:%(col)d: %(code)s %(text)s' > flake8_results.txt 2>&1; then
          echo "âœ… Flake8 ê²€ì‚¬ í†µê³¼" >> code_review.md
        else
          echo "âŒ Flake8 ê²€ì‚¬ ì‹¤íŒ¨" >> code_review.md
          echo '```' >> code_review.md
          cat flake8_results.txt >> code_review.md
          echo '```' >> code_review.md
        fi
        
        echo "" >> code_review.md
        echo "### Bandit ë³´ì•ˆ ë¶„ì„" >> code_review.md
        if bandit -r backend/ -f txt > bandit_results.txt 2>&1; then
          echo "âœ… ë³´ì•ˆ ê²€ì‚¬ í†µê³¼" >> code_review.md
        else
          echo "âš ï¸ ë³´ì•ˆ ì´ìŠˆ ë°œê²¬" >> code_review.md
          echo '```' >> code_review.md
          tail -20 bandit_results.txt >> code_review.md
          echo '```' >> code_review.md
        fi
        
        echo "" >> code_review.md
        echo "---" >> code_review.md
        echo "ğŸ¤– **ìë™ ì½”ë“œ ë¦¬ë·° ë´‡**ì´ ìƒì„±í•œ ë¦¬í¬íŠ¸ì…ë‹ˆë‹¤." >> code_review.md
        echo "ìƒì„¸í•œ ë‚´ìš©ì€ CI ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”." >> code_review.md
      continue-on-error: true
        
    - name: ì½”ë“œ ë¦¬ë·° ëŒ“ê¸€ ì¶”ê°€
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const { owner, repo, number } = context.issue;
          
          let reviewComment = '';
          try {
            reviewComment = fs.readFileSync('code_review.md', 'utf8');
          } catch (error) {
            reviewComment = 'ğŸ¤– ìë™ ì½”ë“œ ë¦¬ë·°ë¥¼ ì‹¤í–‰í•  ìˆ˜ ì—†ì—ˆìŠµë‹ˆë‹¤. CI ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.';
          }
          
          await github.rest.issues.createComment({
            owner,
            repo,
            issue_number: number,
            body: reviewComment
          });

  pr-size-check:
    name: PR í¬ê¸° í™•ì¸
    runs-on: ubuntu-latest
    if: github.event.action == 'opened' || github.event.action == 'synchronize'
    
    steps:
    - name: PR í¬ê¸° ë¼ë²¨ë§
      uses: actions/github-script@v7
      with:
        script: |
          const { owner, repo, number } = context.issue;
          
          const { data: pr } = await github.rest.pulls.get({
            owner,
            repo,
            pull_number: number
          });
          
          const additions = pr.additions;
          const deletions = pr.deletions;
          const changedLines = additions + deletions;
          
          // ê¸°ì¡´ í¬ê¸° ë¼ë²¨ ì œê±°
          const sizeLabels = ['size/XS', 'size/S', 'size/M', 'size/L', 'size/XL'];
          const { data: labels } = await github.rest.issues.listLabelsOnIssue({
            owner,
            repo,
            issue_number: number
          });
          
          for (const label of labels) {
            if (sizeLabels.includes(label.name)) {
              await github.rest.issues.removeLabel({
                owner,
                repo,
                issue_number: number,
                name: label.name
              });
            }
          }
          
          // ìƒˆë¡œìš´ í¬ê¸° ë¼ë²¨ ì¶”ê°€
          let sizeLabel = '';
          if (changedLines <= 10) {
            sizeLabel = 'size/XS';
          } else if (changedLines <= 100) {
            sizeLabel = 'size/S';
          } else if (changedLines <= 500) {
            sizeLabel = 'size/M';
          } else if (changedLines <= 1000) {
            sizeLabel = 'size/L';
          } else {
            sizeLabel = 'size/XL';
          }
          
          await github.rest.issues.addLabels({
            owner,
            repo,
            issue_number: number,
            labels: [sizeLabel]
          });
          
          // ëŒ€ìš©ëŸ‰ PRì— ëŒ€í•œ ê²½ê³  ëŒ“ê¸€
          if (changedLines > 1000) {
            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: number,
              body: `âš ï¸ **ëŒ€ìš©ëŸ‰ PR ê°ì§€** \n\nì´ PRì€ ${changedLines}ì¤„ì˜ ë³€ê²½ì‚¬í•­ì„ í¬í•¨í•˜ê³  ìˆìŠµë‹ˆë‹¤. ë¦¬ë·°ì˜ íš¨ìœ¨ì„±ì„ ìœ„í•´ ë” ì‘ì€ ë‹¨ìœ„ë¡œ ë¶„í• í•˜ëŠ” ê²ƒì„ ê³ ë ¤í•´ë³´ì„¸ìš”.`
            });
          } 